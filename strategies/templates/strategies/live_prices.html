{% extends "strategies/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
<!DOCTYPE HTML>
<html>
<head>

<script>
    function get_live_price() {
        var price;
        $.ajax({
            url: "{% url 'price' stock=stock %}",
            success:  function(response){
                price = response.price
                time = response.time
                document.getElementById("price").value = price
                document.getElementById("time").value = time
            }
        });
    };
    window.onload = function () {

        var dps = []; // dataPoints
        var historical_prices = {{ dps }};
        var today = new Date()
        var year = today.getFullYear()
        var month = today.getMonth()
        var day = today.getDate()
        var start_time = new Date(year=year, month=month, day=day, hours=9, minutes=30);
        for (const [key, value] of Object.entries(historical_prices)) {
            let hour = String(start_time.getHours());
            let minutes = String(start_time.getMinutes());
            let time = hour.concat(":", minutes);
            dps.push({
                label: time,
                y: value
            })
            console.log(dps)
            start_time.setMinutes(start_time.getMinutes() + 1);
        }
        var chart = new CanvasJS.Chart("chartContainer", {
            axisX:{
                title: "Time in Minutes"
            },
            axisY:{
                title: "Price in US Dollars"
            },
            title :{
                text: "Live Prices"
            },
            data: [{
                type: "line",
                dataPoints: dps,
                lineColor: "green",
            }]
        });
        var updateInterval = 1000;

        var updateChart = function (count) {

            count = count || 1;
            var current_time = new Date()
            var startTime = '09:30:00';
            var endTime = '16:30:00';
            currentDate = new Date()   
            startDate = new Date(currentDate.getTime());
            startDate.setHours(startTime.split(":")[0]);
            startDate.setMinutes(startTime.split(":")[1]);
            startDate.setSeconds(startTime.split(":")[2]);
            endDate = new Date(currentDate.getTime());
            endDate.setHours(endTime.split(":")[0]);
            endDate.setMinutes(endTime.split(":")[1]);
            endDate.setSeconds(endTime.split(":")[2]);
            valid = startDate < currentDate && endDate > currentDate

            while (valid) {
                get_live_price()
                var yVal = document.getElementById("price").value;
                var time = document.getElementById("time").value;
                dps.push({
                    y: yVal,
                    label: time,
                });
                var current_time = new Date()
                var startTime = '09:30:00';
                var endTime = '16:30:00';
                currentDate = new Date()   
                startDate = new Date(currentDate.getTime());
                startDate.setHours(startTime.split(":")[0]);
                startDate.setMinutes(startTime.split(":")[1]);
                startDate.setSeconds(startTime.split(":")[2]);
                endDate = new Date(currentDate.getTime());
                endDate.setHours(endTime.split(":")[0]);
                endDate.setMinutes(endTime.split(":")[1]);
                endDate.setSeconds(endTime.split(":")[2]);
                valid = startDate < currentDate && endDate > currentDate
            }
            

            chart.render();
        };

        updateChart();
        setInterval(function(){updateChart()}, updateInterval);
    }
</script>
</head>
<body>
<div id="price"></div>
<div id="time"></div>
<h5>{{stock}}</h5>
<div id="chartContainer" style="height: 300px; width: 100%;"></div>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</body>
</html>
{% endblock content %}